{% extends "base.html" %} {% block title %}文件管理{% endblock %} {% block
menu_key %}files{% endblock %} {% block content %} {% raw %}
<a-layout-content style="margin: 16px">
  <a-breadcrumb style="margin-bottom: 16px">
    <a-breadcrumb-item v-for="(path, index) in breadcrumbItems" :key="index">
      <a @click="navigateTo(path.path)">{{ path.name }}</a>
    </a-breadcrumb-item>
  </a-breadcrumb>
  <a-card>
    <div style="margin-bottom: 16px; display: flex; gap: 8px">
      <a-button-group>
        <a-button type="primary" @click="showCreateModal('file')">
          <a-icon type="file-add"></a-icon>
          新建文件
        </a-button>
        <a-button type="primary" @click="showCreateModal('dir')">
          <a-icon type="folder-add"></a-icon>
          新建文件夹
        </a-button>
      </a-button-group>
      <a-button :disabled="currentPath === '/'" @click="navigateUp">
        <a-icon type="arrow-left"></a-icon>返回上一级
      </a-button>
      <a-button @click="loadFileList">
        <a-icon type="reload"></a-icon>刷新
      </a-button>
    </div>
    <a-table
      :columns="columns"
      :data-source="fileList"
      :pagination="pagination"
      @change="handleTableChange"
    >
      <template slot="name" slot-scope="text, record">
        <a v-if="record.type === 'dir'" @click="enterDirectory(record.name)">
          <a-icon
            type="folder"
            theme="filled"
            style="margin-right: 8px"
          ></a-icon>
          {{ record.name }}
          <span v-if="record.target" style="color: #999; margin-left: 8px">
            &rarr; {{ record.target }}
          </span>
        </a>
        <span v-else>
          <a-icon type="file" style="margin-right: 8px"></a-icon>
          {{ record.name }}
          <span v-if="record.target" style="color: #999; margin-left: 8px">
            &rarr; {{ record.target }}
          </span>
        </span>
      </template>
      <template slot="owner" slot-scope="text, record">
        <span>
          {{ groupsMap[record.gid] || record.gid }} / {{ usersMap[record.uid] ||
          record.uid }}
        </span>
      </template>
      <template slot="action" slot-scope="text, record">
        <a-button-group>
          <a-button
            type="link"
            v-if="record.type !== 'dir'"
            @click="handleDownload(record)"
          >
            <a-icon type="download"></a-icon>
            下载
          </a-button>
          <a-button
            type="link"
            v-if="record.type !== 'dir'"
            @click="showEditModal(record)"
          >
            <a-icon type="edit"></a-icon>
            编辑
          </a-button>
          <a-button type="link" @click="showRenameModal(record)">
            <a-icon type="edit"></a-icon>
            重命名
          </a-button>
          <a-button type="link" @click="showPermissionModal(record)">
            <a-icon type="setting"></a-icon>
            权限
          </a-button>
          <a-button
            type="link"
            style="color: #ff4d4f"
            @click="showDeleteConfirm(record)"
          >
            <a-icon type="delete"></a-icon>
            删除
          </a-button>
        </a-button-group>
      </template>
    </a-table>
  </a-card>
</a-layout-content>
{% endraw %} {% endblock %} {% block modal %} {% raw %}
<a-modal
  :visible="createModalVisible"
  :title="createType === 'file' ? '新建文件' : '新建文件夹'"
  @ok="handleCreate"
  @cancel="createModalVisible = false"
  :ok-text="'确定'"
  :cancel-text="'取消'"
>
  <a-form-item label="名称">
    <a-input v-model="createName" placeholder="请输入名称"></a-input>
  </a-form-item>
</a-modal>
<a-modal
  :visible="renameModalVisible"
  title="重命名"
  @ok="handleRename"
  @cancel="renameModalVisible = false"
  :ok-text="'确定'"
  :cancel-text="'取消'"
>
  <a-form-item label="新名称">
    <a-input
      v-model="newName"
      :placeholder="'请输入新的名称（原名称：' + oldName + '）'"
    ></a-input>
  </a-form-item>
</a-modal>
<a-modal
  :visible="editModalVisible"
  title="编辑文件"
  centered
  width="calc(100vw - 96px)"
  @ok="handleEdit"
  @cancel="editModalVisible = false"
  :ok-text="'保存'"
  :cancel-text="'取消'"
>
  <div
    ref="editor"
    style="height: calc(100vh - 256px); border: 1px solid #d9d9d9"
  ></div>
</a-modal>
<a-modal
  :visible="permissionModalVisible"
  title="权限"
  @ok="handlePermission"
  @cancel="permissionModalVisible = false"
  :ok-text="'确定'"
  :cancel-text="'取消'"
>
  <a-form-item label="权限模式">
    <div style="border: 1px solid #d9d9d9; padding: 16px; border-radius: 2px">
      <table style="width: 100%; text-align: center">
        <tr>
          <th style="width: 25%"></th>
          <th style="width: 25%">读取 (4)</th>
          <th style="width: 25%">写入 (2)</th>
          <th style="width: 25%">执行 (1)</th>
        </tr>
        <tr>
          <td>所有者</td>
          <td><a-checkbox v-model="permissions.owner.read"></a-checkbox></td>
          <td><a-checkbox v-model="permissions.owner.write"></a-checkbox></td>
          <td><a-checkbox v-model="permissions.owner.execute"></a-checkbox></td>
        </tr>
        <tr>
          <td>用户组</td>
          <td><a-checkbox v-model="permissions.group.read"></a-checkbox></td>
          <td><a-checkbox v-model="permissions.group.write"></a-checkbox></td>
          <td><a-checkbox v-model="permissions.group.execute"></a-checkbox></td>
        </tr>
        <tr>
          <td>其他人</td>
          <td><a-checkbox v-model="permissions.other.read"></a-checkbox></td>
          <td><a-checkbox v-model="permissions.other.write"></a-checkbox></td>
          <td><a-checkbox v-model="permissions.other.execute"></a-checkbox></td>
        </tr>
      </table>
      <div style="margin-top: 8px; color: #999; text-align: right">
        权限值：{{ permissionMode }}
      </div>
    </div>
  </a-form-item>
  <a-form-item label="所有者">
    <a-select
      v-model="permissionOwner"
      style="width: 100%"
      placeholder="请选择所有者"
    >
      <a-select-option v-for="(name, uid) in usersMap" :key="uid" :value="uid">
        {{ name }}
      </a-select-option>
    </a-select>
  </a-form-item>
  <a-form-item label="用户组">
    <a-select
      v-model="permissionGroup"
      style="width: 100%"
      placeholder="请选择用户组"
    >
      <a-select-option v-for="(name, gid) in groupsMap" :key="gid" :value="gid">
        {{ name }}
      </a-select-option>
    </a-select>
  </a-form-item>
</a-modal>
{% endraw %} {% endblock %} {% block script %} {% raw %}
<script>
  new Vue({
    el: "#app",
    data() {
      return {
        currentPath: "/",
        createModalVisible: false,
        createType: "file",
        createName: "",
        renameModalVisible: false,
        oldName: "",
        newName: "",
        editModalVisible: false,
        editingFile: null,
        editor: null,
        fileList: [],
        pagination: {
          current: 1,
          pageSize: 15,
          total: 0,
        },
        usersMap: {},
        groupsMap: {},
        permissionModalVisible: false,
        permissions: {
          owner: {
            read: false,
            write: false,
            execute: false,
          },
          group: {
            read: false,
            write: false,
            execute: false,
          },
          other: {
            read: false,
            write: false,
            execute: false,
          },
        },
        permissionOwner: null,
        permissionGroup: null,
        permissionFile: null,
        changePasswordVisible: false,
        changePasswordForm: {
          old_password: '',
          new_password: '',
          confirm_password: ''
        },
        columns: [
          {
            title: "名称",
            dataIndex: "name",
            key: "name",
            scopedSlots: { customRender: "name" },
          },
          {
            title: "大小",
            dataIndex: "size",
            key: "size",
            customRender: (text) => {
              if (text < 1024) return text + " B";
              if (text < 1024 * 1024) return (text / 1024).toFixed(2) + " KB";
              return (text / 1024 / 1024).toFixed(2) + " MB";
            },
          },
          {
            title: "修改时间",
            dataIndex: "last_modified",
            key: "last_modified",
            customRender: (text) => new Date(text * 1000).toLocaleString(),
          },
          {
            title: "权限",
            dataIndex: "permission",
            key: "permission",
          },
          {
            title: "所有者",
            key: "owner",
            scopedSlots: { customRender: "owner" },
          },
          {
            title: "操作",
            key: "action",
            scopedSlots: { customRender: "action" },
          },
        ],
      };
    },
    computed: {
      breadcrumbItems() {
        const paths = [{ name: "根目录", path: "/" }];
        if (this.currentPath === "/") return paths;
        const parts = this.currentPath.split("/").filter(Boolean);
        let currentPath = "";
        for (const part of parts) {
          currentPath += "/" + part;
          paths.push({
            name: part,
            path: currentPath,
          });
        }
        return paths;
      },
      permissionMode() {
        const getNum = (perm) => {
          return (perm.read ? 4 : 0) + (perm.write ? 2 : 0) + (perm.execute ? 1 : 0);
        };
        const owner = getNum(this.permissions.owner);
        const group = getNum(this.permissions.group);
        const other = getNum(this.permissions.other);
        return `${owner}${group}${other}`;
      },
    },
    methods: {
      loadUsers() {
        return axios
          .get("/api/system/user/list")
          .then((response) => {
            if (response.data.status === "success") {
              this.usersMap = response.data.data.reduce((map, user) => {
                map[user.uid] = user.name;
                return map;
              }, {});
            }
            return response;
          })
          .catch(() => {
            this.$message.error("获取用户列表失败");
          });
      },
      loadGroups() {
        return axios
          .get("/api/system/group/list")
          .then((response) => {
            if (response.data.status === "success") {
              this.groupsMap = response.data.data.reduce((map, group) => {
                map[group.gid] = group.name;
                return map;
              }, {});
            }
            return response;
          })
          .catch(() => {
            this.$message.error("获取用户组列表失败");
          });
      },
      loadFileList() {
        Promise.all([
          this.loadUsers(),
          this.loadGroups(),
          axios.get("/api/file/list", {
            params: {
              path: this.currentPath,
              page: this.pagination.current,
              per_page: this.pagination.pageSize,
            },
          }),
        ])
          .then(([_, __, response]) => {
            if (response.data.status === "success") {
              this.fileList = response.data.data.items;
              this.pagination.total = response.data.data.total;
            } else {
              this.fileList = [];
              this.pagination.total = 0;
              this.$message.error(response.data.message);
            }
          })
          .catch((error) => {
            this.fileList = [];
            this.pagination.total = 0;
            this.$message.error("获取文件列表失败");
          });
      },
      handleTableChange(pagination) {
        this.pagination.current = pagination.current;
        this.loadFileList();
      },
      enterDirectory(dirname) {
        this.currentPath += "/" + dirname;
        this.pagination.current = 1;
        this.loadFileList();
      },
      navigateTo(path) {
        this.currentPath = path;
        this.pagination.current = 1;
        this.loadFileList();
      },
      showCreateModal(type) {
        this.createType = type;
        this.createName = "";
        this.createModalVisible = true;
      },
      handleCreate() {
        if (!this.createName) {
          this.$message.error("请输入名称");
          return;
        }
        const path =
          this.currentPath === "/"
            ? "/" + this.createName
            : this.currentPath + "/" + this.createName;

        const params = new URLSearchParams();
        params.append("path", path);
        params.append("type", this.createType);

        axios
          .post("/api/file/create", params, {
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          })
          .then((response) => {
            if (response.data.status === "success") {
              this.$message.success(
                this.createType === "file" ? "文件创建成功" : "文件夹创建成功"
              );
              this.loadFileList();
            } else {
              this.$message.error(response.data.message);
            }
          })
          .catch(() => {
            this.$message.error(
              this.createType === "file" ? "文件创建失败" : "文件夹创建失败"
            );
          })
          .finally(() => {
            this.createModalVisible = false;
          });
      },
      showRenameModal(record) {
        this.oldName = record.name;
        this.newName = record.name;
        this.renameModalVisible = true;
      },
      handleRename() {
        if (!this.newName) {
          this.$message.error("请输入新名称");
          return;
        }
        if (this.newName === this.oldName) {
          this.$message.info("新名称与原名称相同");
          this.renameModalVisible = false;
          return;
        }

        const sourcePath =
          this.currentPath === "/"
            ? "/" + this.oldName
            : this.currentPath + "/" + this.oldName;
        const destPath =
          this.currentPath === "/"
            ? "/" + this.newName
            : this.currentPath + "/" + this.newName;

        const params = new URLSearchParams();
        params.append("source", sourcePath);
        params.append("destination", destPath);

        axios
          .patch("/api/file/move", params, {
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          })
          .then((response) => {
            if (response.data.status === "success") {
              this.$message.success("重命名成功");
              this.loadFileList();
            } else {
              this.$message.error(response.data.message);
            }
          })
          .catch(() => {
            this.$message.error("重命名失败");
          })
          .finally(() => {
            this.renameModalVisible = false;
          });
      },
      showDeleteConfirm(record) {
        const path =
          this.currentPath === "/"
            ? "/" + record.name
            : this.currentPath + "/" + record.name;

        this.$confirm({
          title: "确认删除",
          content: `确定要删除${record.type === "dir" ? "文件夹" : "文件"} "${
            record.name
          }" 吗？`,
          okText: "确认",
          okType: "danger",
          cancelText: "取消",
          onOk: () => {
            const params = new URLSearchParams();
            params.append("path", path);

            axios
              .delete("/api/file/delete", {
                data: params,
                headers: {
                  "Content-Type": "application/x-www-form-urlencoded",
                },
              })
              .then((response) => {
                if (response.data.status === "success") {
                  this.$message.success("删除成功");
                  this.loadFileList();
                } else {
                  this.$message.error(response.data.message);
                }
              })
              .catch(() => {
                this.$message.error("删除失败");
              });
          },
        });
      },
      handleDownload(record) {
        const path =
          this.currentPath === "/"
            ? "/" + record.name
            : this.currentPath + "/" + record.name;

        axios
          .get("/api/file/download", {
            params: {
              path: path,
            },
            responseType: "blob",
          })
          .then((response) => {
            const filename = record.name;

            const url = window.URL.createObjectURL(new Blob([response.data]));
            const link = document.createElement("a");
            link.href = url;
            link.setAttribute("download", filename);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            window.URL.revokeObjectURL(url);

            this.$message.success("下载成功");
          })
          .catch((error) => {
            if (error.response && error.response.data instanceof Blob) {
              const reader = new FileReader();
              reader.onload = () => {
                try {
                  const errorData = JSON.parse(reader.result);
                  this.$message.error(errorData.message || "下载失败");
                } catch (e) {
                  this.$message.error("下载失败");
                }
              };
              reader.readAsText(error.response.data);
            } else {
              this.$message.error("下载失败");
            }
          });
      },
      showEditModal(record) {
        const path =
          this.currentPath === "/"
            ? "/" + record.name
            : this.currentPath + "/" + record.name;

        axios
          .get("/api/file/read", {
            params: {
              path: path,
            },
          })
          .then((response) => {
            if (response.data.status === "success") {
              this.editingFile = {
                path: path,
                name: record.name,
              };
              this.editModalVisible = true;
              this.$nextTick(() => {
                if (!this.editor) {
                  this.editor = CodeMirror(this.$refs.editor, {
                    mode: this.getFileMode(record.name),
                    theme: "monokai",
                    lineNumbers: true,
                    autofocus: true,
                  });
                  this.editor.setSize("100%", "100%");
                }
                this.editor.setValue(response.data.data);
                this.editor.refresh();
              });
            } else {
              this.$message.error("此文件过大或不是文本文件，无法编辑");
            }
          })
          .catch(() => {
            this.$message.error("读取文件失败");
          });
      },
      handleEdit() {
        if (!this.editingFile) return;

        const params = new URLSearchParams();
        params.append("path", this.editingFile.path);
        params.append("content", this.editor.getValue());

        axios
          .patch("/api/file/write", params, {
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          })
          .then((response) => {
            if (response.data.status === "success") {
              this.$message.success("保存成功");
              this.loadFileList();
            } else {
              this.$message.error(response.data.message);
            }
          })
          .catch(() => {
            this.$message.error("保存失败");
          })
          .finally(() => {
            this.editModalVisible = false;
          });
      },
      getFileMode(filename) {
        const ext = filename.split(".").pop().toLowerCase();
        const modeMap = {
          js: "javascript",
          json: "javascript",
          html: "xml",
          htm: "xml",
          xml: "xml",
          css: "css",
          py: "python",
          sh: "shell",
          bash: "shell",
        };
        return modeMap[ext] || "javascript";
      },
      showPermissionModal(record) {
        Promise.all([this.loadUsers(), this.loadGroups()])
          .then(() => {
            this.permissionFile = record;
            const mode = record.permission;
            const owner = parseInt(mode[0]);
            const group = parseInt(mode[1]);
            const other = parseInt(mode[2]);

            const setBits = (num) => ({
              read: !!(num & 4),
              write: !!(num & 2),
              execute: !!(num & 1),
            });

            this.permissions = {
              owner: setBits(owner),
              group: setBits(group),
              other: setBits(other),
            };

            this.permissionOwner = record.uid.toString();
            this.permissionGroup = record.gid.toString();
            this.permissionModalVisible = true;
          })
          .catch(() => {
            this.$message.error("加载用户和组信息失败");
          });
      },
      handlePermission() {
        if (!this.permissionFile || !this.permissionMode) {
          this.$message.error("请填写完整的权限信息");
          return;
        }

        const path =
          this.currentPath === "/"
            ? "/" + this.permissionFile.name
            : this.currentPath + "/" + this.permissionFile.name;

        const params = new URLSearchParams();
        params.append("path", path);
        params.append("mode", parseInt(this.permissionMode, 8).toString(10));
        params.append("owner", this.permissionOwner);
        params.append("group", this.permissionGroup);

        axios
          .patch("/api/file/permission", params, {
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
          })
          .then((response) => {
            if (response.data.status === "success") {
              this.$message.success("权限设置成功");
              this.loadFileList();
            } else {
              this.$message.error(response.data.message);
            }
          })
          .catch(() => {
            this.$message.error("权限设置失败");
          })
          .finally(() => {
            this.permissionModalVisible = false;
          });
      },
      navigateUp() {
        if (this.currentPath === "/") return;
        const parentPath =
          this.currentPath.split("/").slice(0, -1).join("/") || "/";
        this.navigateTo(parentPath);
      },
      {% endraw %}{% include "common.js" %}{% raw %}
    },
    mounted() {
      this.loadFileList();
    },
  });
</script>
{% endraw %} {% endblock %}
